<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../img/favicon.ico">

        <title>Developer Guide - mettle</title>

        <link href="../css/bootstrap-custom.min.css" rel="stylesheet">
        <link href="../css/font-awesome-4.0.3.css" rel="stylesheet">
        <link href="../css/prettify-1.0.css" rel="stylesheet">
        <link href="../css/base.css" rel="stylesheet">
        <link href="../css/extra.css" rel="stylesheet">

        <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
        <![endif]-->
    </head>

    <body>

        <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>

            <!-- Main title -->
            <a class="navbar-brand" href="..">mettle</a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
            <!-- Main navigation -->
            <ul class="nav navbar-nav">
            
            
                <li >
                    <a href="../install">Installation</a>
                </li>
            
            
            
                <li class="dropdown">
                    <a href="#" class="dropdown-toggle" data-toggle="dropdown">User Guide <b class="caret"></b></a>
                    <ul class="dropdown-menu">
                    
                        <li >
                            <a href="../running-tests">Running Tests</a>
                        </li>
                    
                        <li >
                            <a href="../writing-tests">Writing Tests</a>
                        </li>
                    
                        <li >
                            <a href="../matchers">Expectations and Matchers</a>
                        </li>
                    
                    </ul>
                </li>
            
            
            
                <li class="active">
                    <a href=".">Developer Guide</a>
                </li>
            
            
            
                <li >
                    <a href="../license">License</a>
                </li>
            
            
            </ul>

            <!-- Search, Navigation and Repo links -->
            <ul class="nav navbar-nav navbar-right">
                
                <li >
                    <a rel="next" href="../matchers">
                        <i class="fa fa-arrow-left"></i> Previous
                    </a>
                </li>
                <li >
                    <a rel="prev" href="../license">
                        Next <i class="fa fa-arrow-right"></i>
                    </a>
                </li>
                
                <li>
                    <a href="https://github.com/jimporter/mettle/">
                        
                            <i class="fa fa-github"></i>
                        
                        GitHub
                    </a>
                </li>
                
            </ul>
        </div>
    </div>
</div>

        <div class="container">
            <div class="col-md-3"><div class="bs-sidebar hidden-print affix well" role="complementary">
    <ul class="nav bs-sidenav">
    
        <li class="main active"><a href="#developer-guide">Developer Guide</a></li>
        
            <li><a href="#basic-structure">Basic structure</a></li>
        
            <li><a href="#suites">Suites</a></li>
        
    
    </ul>
</div></div>
            <div class="col-md-9" role="main">

<h1 id="developer-guide">Developer Guide</h1>
<hr />
<p>If you're looking to learn about how mettle actually works, you've come to the
right place! This developer guide will describe mettle's internals and how
everything fits together.</p>
<h2 id="basic-structure">Basic structure</h2>
<p>mettle's structure is a bit different from other test frameworks. First, like
some other test frameworks, individual (user-written) test files link to a
shared library (<code>libmettle.so</code>) to pull in common driver code.</p>
<p>However, in addition, the <code>mettle</code> test driver can be used to aggregate the
results of multiple test files. This lets you put your tests into multiple,
separate binaries to reduce compilation time and allow different kinds of tests
to be run all at once (e.g. normal unit tests and compilation-failure tests).</p>
<h3 id="subprocesses">Subprocesses</h3>
<p>When running tests, mettle makes extensive use of subprocesses to isolate tests
as much as possible. First, the <code>mettle</code> driver forks/execs each individual test
binary, and these in turn (by default) fork for each test in the file. This
ensures that no one test can crash the entire framework. The <em>test process</em> is
also set as the process group leader for a new process group in order to ensure
that any subprocesses of it are killed, if necessary.</p>
<p>Additionally, if tests are set to time out after a certain period, two more
subprocesses are forked for each test: a <em>monitor process</em> and a <em>timer
process</em>. The monitor process forks both the timer process and the actual test
process and waits for the first one to finish. The timer process automatically
exits after the timeout expires, and if it exits before the test process, the
monitor process kills the test and sends a message that it timed out.</p>
<p>You might be thinking, "why not just use <code>alarm(2)</code> or <code>setitimer(2)</code> instead of
forking two extra times?" However, this would interact poorly with tests that
rely on functions like <code>sleep(3)</code>. Hence, in the interest of maximum isolation
of the test code, the timer is implemented as a subprocess.</p>
<h2 id="suites">Suites</h2>
<p>When creating a test suite, the most important argument to pass is the <em>creation
function</em> (conventionally a generic lambda). This function takes a
<code>suite_builder</code> (or a <code>subsuite_builder</code> for subsuites). These are both template
classes that let the user add tests or subsuites to the given suite.</p>
<p>Once the creation function returns, the suite is compiled into a
<code>runnable_suite</code> (subsuites, however, are merely compiled into an intermediary
form and stored in its parent's <code>(sub)suite_builder</code> instance). When the parent
is compiled, the subsuite and all of its tests are compiled as well, until it
gets to the root suite, at which point all tests and subsuites are
fully-compiled.</p>
<p>If using the global <code>suite</code> or <code>basic_suite</code> types, once the suite is
fully-compiled, it gets added to a global list of suites, held in
<code>detail::all_suites()</code> (subsuites, however, are contained within their parents).
This list is then used by the test driver to run all the tests.</p>
</div>
        </div>

        

        <script src="https://code.jquery.com/jquery-1.10.2.min.js"></script>
        <script src="../js/bootstrap-3.0.3.min.js"></script>
        <script src="../js/prettify-1.0.min.js"></script>
        <script src="../js/base.js"></script>
    </body>
</html>